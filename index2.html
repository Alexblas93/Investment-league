<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inversor League - Ranking</title>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 40px; background: #f4f6f9; color: #333; }
    h1, h2 { text-align: center; color: #003366; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #003366; color: white; }
    .profit { color: #2e7d32; font-weight: bold; }
    .loss { color: #c62828; font-weight: bold; }
    .highlight { background-color: #fffacd !important; }
    .total { font-weight: bold; font-size: 1.2em; margin: 20px 0; text-align: right; }
    .user-card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); cursor: pointer; }
    .user-card:hover { background: #f0f0f0; }
    .back-link { display: block; margin: 20px 0; color: #003366; text-decoration: none; font-weight: bold; }
    .back-link:hover { text-decoration: underline; }
    .section { margin: 30px 0; }
    .section-title { color: #003366; margin-bottom: 10px; }
    .crypto { background: #f0f8ff; padding: 10px; border-left: 4px solid #003366; }
    .stock { background: #fff8e1; padding: 10px; border-left: 4px solid #ffa000; }
    .update-time { text-align: center; font-style: italic; color: #666; margin: 10px 0; }
  </style>
</head>
<body>
  <div id="main-view">
    <h1>üèÜ Investment League 2025</h1>
    <p style="text-align:center;"><strong>Actualizaci√≥n autom√°tica</strong></p>
    <div class="update-time" id="update-time">√öltima actualizaci√≥n: Cargando...</div>

    <!-- Tasa EUR/USD -->
    <div style="text-align:center; margin: 20px 0;">
      <span id="eurusd">Tasa EUR/USD: cargando...</span>
    </div>

    <!-- Ranking -->
    <h2>üìä Ranking</h2>
    <table id="ranking-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Usuario</th>
          <th>Valor Actual (‚Ç¨)</th>
          <th>Rentabilidad (‚Ç¨)</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody id="ranking-body">
        <tr><td colspan="5">Cargando...</td></tr>
      </tbody>
    </table>

    <!-- Detalle por usuario -->
    <h2>üîç Carteras Individuales</h2>
    <div id="portfolios"></div>
  </div>

  <!-- Vista individual -->
  <div id="individual-view" style="display:none;">
    <a href="#" class="back-link" onclick="showMainView(); return false;">‚Üê Volver al ranking</a>
    <h2 id="user-title">Cartera de [Nombre]</h2>
    <div id="user-details"></div>
    <div class="update-time" id="update-time-individual">√öltima actualizaci√≥n: Cargando...</div>

    <h3>Detalles de Activos</h3>
    <table id="user-investments-table">
      <thead>
        <tr>
          <th>Activo</th>
          <th>Tipo</th>
          <th>Cantidad</th>
          <th>Precio Compra (‚Ç¨)</th>
          <th>Precio Actual (‚Ç¨)</th>
          <th>Valor Actual (‚Ç¨)</th>
          <th>Rentabilidad (‚Ç¨)</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody id="user-investments-body">
        <tr><td colspan="8">Cargando...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const DATA_FILE = 'data.json';
    let eurusd = 1.08;
    let currentView = 'main';
    let allData = null;
    let yahooPrices = {};
    let userResults = [];

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    async function fetchData() {
      try {
        const res = await fetch(DATA_FILE);
        const data = await res.json();
        allData = data;

        // Obtener precios actuales
        const symbols = [...new Set(data.users.flatMap(u => u.investments.map(i => i.symbol)))];

        // Precios de Yahoo Finance con proxy
        yahooPrices = {};
        for (const sym of symbols) {
          try {
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1d&interval=1d`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;
            
            const r = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
            const d = await r.json();
            
            if (d.contents) {
              const parsed = JSON.parse(d.contents);
              if (parsed.chart.result && parsed.chart.result[0].meta.regularMarketPrice) {
                yahooPrices[sym] = parsed.chart.result[0].meta.regularMarketPrice;
              } else {
                console.warn(`‚ö†Ô∏è ${sym}: No se encontr√≥ precio en los datos`);
                yahooPrices[sym] = 0;
              }
            } else {
              console.warn(`‚ùå ${sym}: Proxy devolvi√≥ datos vac√≠os`);
              yahooPrices[sym] = 0;
            }
          } catch (e) {
            console.warn(`‚ùå Error al obtener ${sym} con proxy:`, e.message);
            yahooPrices[sym] = 0;
          }
        }

        // Actualizar tasa EUR/USD
        try {
          const eurusdData = await fetch('https://api.exchangerate-api.com/v4/latest/USD').then(r => r.json());
          eurusd = 1 / eurusdData.rates.EUR;
          document.getElementById('eurusd').textContent = `Tasa EUR/USD: ${eurusd.toFixed(4)}`;
        } catch (e) {
          console.warn("No se pudo actualizar EUR/USD");
        }

        // Calcular valor actual y rentabilidad por usuario
        userResults = data.users.map(user => {
          let investedEur = 0;
          let currentEur = 0;

          user.investments.forEach(inv => {
            let buyPriceEur = inv.currency === 'EUR' ? inv.buy_price_eur : inv.buy_price_usd / eurusd;
            let quantity = inv.quantity;
            let currentPriceUsd = yahooPrices[inv.symbol];

            if (!currentPriceUsd || currentPriceUsd <= 0) {
              console.log(`‚ö†Ô∏è Precio no disponible para ${inv.symbol}`);
              currentPriceUsd = 0;
            }

            let currentPriceEur = inv.currency === 'EUR' ? currentPriceUsd : currentPriceUsd / eurusd;

            investedEur += quantity * buyPriceEur;
            currentEur += quantity * currentPriceEur;
          });

          return {
            name: user.name,
            invested: investedEur,
            current: currentEur,
            profit: currentEur - investedEur,
            pct: investedEur > 0 ? (currentEur - investedEur) / investedEur * 100 : 0
          };
        });

        // Ordenar ranking
        userResults.sort((a, b) => b.profit - a.profit);

        // Mostrar ranking
        const tbody = document.getElementById('ranking-body');
        tbody.innerHTML = '';
        userResults.forEach((r, idx) => {
          const row = tbody.insertRow();
          row.classList.toggle('highlight', r.name === 'T√∫');
          row.innerHTML = `
            <td>${idx+1}</td>
            <td><a href="#" onclick="showUserView('${r.name}'); return false;" style="color: #003366; text-decoration: none; font-weight: bold;">${r.name}</a></td>
            <td>‚Ç¨${formatMoney(r.current)}</td>
            <td class="${r.profit >= 0 ? 'profit' : 'loss'}">‚Ç¨${formatMoney(r.profit)}</td>
            <td class="${r.pct >= 0 ? 'profit' : 'loss'}">${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(2)}%</td>
          `;
        });

        // Mostrar detalle por usuario
        const portfoliosDiv = document.getElementById('portfolios');
        portfoliosDiv.innerHTML = '';
        userResults.forEach(r => {
          const card = document.createElement('div');
          card.className = 'user-card';
          card.innerHTML = `<strong>${r.name}</strong>: ‚Ç¨${formatMoney(r.current)} (${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(2)}%)`;
          card.onclick = () => showUserView(r.name);
          portfoliosDiv.appendChild(card);
        });

        // Actualizar hora en vista principal
        document.getElementById('update-time').textContent = `√öltima actualizaci√≥n: ${getCurrentTime()}`;
      } catch (e) {
        console.error("Error en fetchData:", e);
        document.getElementById('ranking-body').innerHTML = '<tr><td colspan="5">Error al cargar datos. Revisa tu conexi√≥n o el archivo data.json.</td></tr>';
      }
    }

    function showUserView(userName) {
      const userResult = userResults.find(u => u.name === userName);
      if (!userResult) return;

      document.getElementById('main-view').style.display = 'none';
      document.getElementById('individual-view').style.display = 'block';

      document.getElementById('user-title').textContent = `Cartera de ${userName}`;
      document.getElementById('user-details').innerHTML = `
        <p><strong>Valor Actual:</strong> ‚Ç¨${formatMoney(userResult.current)}</p>
        <p><strong>Rentabilidad Total:</strong> ‚Ç¨${formatMoney(userResult.profit)} (${userResult.pct >= 0 ? '+' : ''}${userResult.pct.toFixed(2)}%)</p>
      `;

      // Actualizar hora en vista individual
      document.getElementById('update-time-individual').textContent = `√öltima actualizaci√≥n: ${getCurrentTime()}`;

      const user = allData.users.find(u => u.name === userName);
      if (!user) return;

      const tbody = document.getElementById('user-investments-body');
      tbody.innerHTML = '';

      user.investments.forEach(inv => {
        let buyPriceEur = inv.currency === 'EUR' ? inv.buy_price_eur : inv.buy_price_usd / eurusd;
        let quantity = inv.quantity;
        let currentPriceUsd = yahooPrices[inv.symbol];

        if (!currentPriceUsd || currentPriceUsd <= 0) {
          console.log(`‚ö†Ô∏è Precio no disponible para ${inv.symbol}`);
          currentPriceUsd = 0;
        }

        let currentPriceEur = inv.currency === 'EUR' ? currentPriceUsd : currentPriceUsd / eurusd;
        let currentValue = quantity * currentPriceEur;
        let profit = currentValue - (quantity * buyPriceEur);
        let pct = (buyPriceEur > 0) ? (profit / (quantity * buyPriceEur)) * 100 : 0;

        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${inv.symbol}</td>
          <td>${inv.type}</td>
          <td>${quantity}</td>
          <td>‚Ç¨${formatMoney(buyPriceEur)}</td>
          <td>‚Ç¨${formatMoney(currentPriceEur)}</td>
          <td>‚Ç¨${formatMoney(currentValue)}</td>
          <td class="${profit >= 0 ? 'profit' : 'loss'}">‚Ç¨${formatMoney(profit)}</td>
          <td class="${pct >= 0 ? 'profit' : 'loss'}">${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%</td>
        `;
      });
    }

    function showMainView() {
      document.getElementById('main-view').style.display = 'block';
      document.getElementById('individual-view').style.display = 'none';
    }

    function formatMoney(n) {
      return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2 }).format(n);
    }

    // Primera carga
    fetchData();
    setInterval(fetchData, 60000);
  </script>
</body>
</html>